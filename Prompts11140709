# API Test Generator

**Description**: Automatically generates complete Playwright + Cucumber API test suites from Swagger/OpenAPI specifications with schema validation, flexible authentication, and comprehensive reporting.

**Usage**: 
```
Generate API tests
```

or with explicit reference:

```
@workspace #file:copilot-instructions.md Generate API tests
```

---

## Agent Instructions

### Core Objective

Generate a **complete Playwright + Cucumber API test suite in JavaScript** for all endpoints defined in the API specification configured in the `.env` file, with:
- Schema validation using Ajv
- Flexible authentication (basic/bearer/none)
- Multiple report formats (Cucumber HTML/JSON, Allure dashboard, TEST_SUMMARY.md)
- Automatic retry logic (3 attempts per scenario)

### Configuration Source

Read all configuration from `.env` file:
- `INPUT_TYPE`: API specification format (`swagger_json`, `swagger_url`, `openapi_json`, `openapi_url`)
- `INPUT_PATH`: Location of API specification (file path or URL)
- `BASE_URL`: API base URL endpoint
- `AUTH_TYPE`: Authentication method (`basic`, `bearer`, `none`)
- `AUTH_USERNAME` / `AUTH_PASSWORD`: For Basic Auth
- `AUTH_TOKEN`: For Bearer Token Auth

### Technical Stack

- **Node.js v18+** (ESM modules)
- **Playwright v1.45+** (APIRequestContext)
- **Cucumber.js v10+** (BDD framework with retry)
- **Chai v5+** (assertions)
- **Ajv v8+** (JSON Schema validation)
- **Allure** (allure-commandline, allure-js-commons)
  - **Note**: `allure-cucumberjs` reporter doesn't work properly with ESM modules. Use `generate-allure.js` script to convert Cucumber JSON to Allure format.
- **dotenv** (environment configuration)

---

## Project Structure

```
features/
├── step_definitions/
│   ├── <endpoint1>_steps.js      # Step definitions for endpoint1
│   └── <endpoint2>_steps.js      # Step definitions for endpoint2
├── support/
│   ├── world.js                  # Playwright context initialization
│   └── hooks.js                  # Setup and teardown hooks
├── <endpoint1>.feature           # Gherkin scenarios for endpoint1
└── <endpoint2>.feature           # Gherkin scenarios for endpoint2
helpers/
├── <endpoint1>ApiHelper.js       # API helper for endpoint1
├── <endpoint2>ApiHelper.js       # API helper for endpoint2
├── retryHelper.js                # Retry logic utilities
└── schemaValidator.js            # JSON Schema validation (Ajv)
models/
├── <endpoint1>Models.js          # Data models for endpoint1
└── <endpoint2>Models.js          # Data models for endpoint2
reports/                          # Generated test reports
├── cucumber-report.html
└── cucumber-report.json
allure-results/                   # Allure test results (generated)
allure-report/                    # Allure HTML report (generated)
.env                              # Environment configuration
.env.example                      # Environment template
cucumber.js                       # Cucumber configuration (retry: 3, parallel: 1)
playwright.config.js              # Playwright configuration
generate-allure.js                # Cucumber JSON to Allure converter
package.json                      # Dependencies and scripts
TEST_SUMMARY.md                   # Test execution summary (generated)
```

**Naming Convention**: Use lowercase filenames (`store_steps.js`, `storeApiHelper.js`) and camelCase function names (`createOrder()`, `getOrderById()`).

---

## Test Coverage Requirements

### Positive Scenarios (200/201/204)
- Validate successful operations per Swagger/OpenAPI definitions
- **Schema validation** on responses:
  - **GET (200)**: ALWAYS validate response schema
  - **POST/PUT (200/201)**: Validate IF response returns an object (skip simple messages)
- Use status codes defined in specification
- If test fails → indicates API bug (not test bug)

### Negative Scenarios

Generate negative test cases based on HTTP methods:

| HTTP Method | Tested Negative Codes |
|-------------|-----------------------|
| **GET**     | 401, 404, 500         |
| **POST**    | 400, 401, 404, 500    |
| **PUT**     | 400, 404, 500         |
| **DELETE**  | 400, 404, 500         |

**Important**: If Swagger defines specific negative codes, use those instead.

**Expected Failures**:
- API returns 200 instead of 400 → Validation Gap (missing input validation)
- API returns 500 instead of 400/404 → Wrong Error Code (poor error handling)

---

## Schema Validation

**Purpose**: Validate response structure against API specification schemas (API contract compliance)

**When to Validate**:
- **GET requests (200)**: ALWAYS validate
- **POST requests (200/201)**: Validate IF response returns object (skip simple messages)
- **PUT requests (200/201)**: Validate IF response returns object
- **DELETE requests**: Typically no validation (204 No Content)

**Validation Checks**:
- Required fields are present
- Data types match specification (string, number, boolean, array, object)
- Nested objects structure matches schema
- Array items conform to expected schema

**Implementation**:
- Create `helpers/schemaValidator.js` using Ajv library
- Extract schemas from API specification for each endpoint/method
- Integrate validation in step definitions after successful responses
- Return detailed validation errors when schema doesn't match
- Add to `package.json`: `ajv@^8.12.0`, `ajv-formats@^2.1.1`

---

## Authentication Handling

Read `AUTH_TYPE` from `.env` and configure accordingly:

**AUTH_TYPE=basic**:
- Use `AUTH_USERNAME` and `AUTH_PASSWORD`
- Encode as `Authorization: Basic <base64>`

**AUTH_TYPE=bearer**:
- Use `AUTH_TOKEN`
- Set header `Authorization: Bearer <token>`

**AUTH_TYPE=none**:
- No authentication headers

Apply authentication to all requests requiring it per Swagger security definitions.

**Testing 401 Scenarios**: 
Use `@no-auth` tag for cleaner testing without authentication setup/removal steps:

- **Feature files**: Tag 401 scenarios with `@no-auth`, keep Background minimal (only `Given the API base URL is configured`)
- **Before hook** (`features/support/hooks.js`): Check for `@no-auth` tag in `pickle.tags`, call `initWithoutAuth()` instead of `init()`
- **World.js**: Implement `initWithoutAuth()` method that disposes any existing context (clears cache), creates fresh `request.newContext()` with only `Content-Type` header (no Authorization), and initializes API helpers
- **Other scenarios**: Add `Given authentication is set up` step explicitly to scenarios requiring authentication

Example:
```gherkin
Feature: Order API
  Background:
    Given the API base URL is configured

  Scenario: Successfully create order
    Given authentication is set up
    When I send a POST request to create order
    Then the response status code should be 200

  @no-auth
  Scenario: Create order with unauthorized access
    # No auth setup - @no-auth tag triggers initWithoutAuth()
    When I send a POST request to create order
    Then the response status code should be 401
```

---

## Configuration Files

⚠️ **CRITICAL**: Cucumber 10+ requires explicit `--format` flags in the package.json test script. The `format` settings in `cucumber.js` are not reliably applied.

### cucumber.js
```javascript
export default {
  default: {
    require: ['features/support/**/*.js', 'features/step_definitions/**/*.js'],
    format: [
      'progress-bar',
      'html:reports/cucumber-report.html',
      'json:reports/cucumber-report.json'
    ],
    formatOptions: {
      snippetInterface: 'async-await'
    },
    parallel: 1,  // Sequential execution (can be increased for parallel)
    retry: 3,     // Retry failed scenarios 3 times
    publishQuiet: true
  }
};
```

### package.json (scripts)
```json
{
  "type": "module",
  "scripts": {
    "test": "cucumber-js --format progress-bar --format html:reports/cucumber-report.html --format json:reports/cucumber-report.json",
    "test:watch": "nodemon --exec \"npm test\"",
    "generate:allure": "node generate-allure.js",
    "allure:report": "npm run generate:allure && allure generate allure-results --clean -o allure-report",
    "allure:open": "allure open allure-report",
    "test:allure": "npm test && npm run allure:report"
  }
}
```

**Important**: The `test` script must explicitly specify the `--format` options because Cucumber 10+ doesn't always apply the `format` settings from `cucumber.js` file. The explicit format options ensure:
- Progress bar output to console
- HTML report generation to `reports/cucumber-report.html`
- JSON report generation to `reports/cucumber-report.json` (required for Allure conversion)

### generate-allure.js

**Purpose**: Converts Cucumber JSON report to Allure format (required because allure-cucumberjs/reporter doesn't work properly with ESM + Cucumber 10+)

**Location**: Root directory (`generate-allure.js`)

**Implementation**: Reads `reports/cucumber-report.json` and generates Allure result files in `allure-results/` directory with proper test metadata, steps, timing, and status information.

---

## Reporting Requirements

Generate **three report formats**:

### 1. Cucumber HTML/JSON Reports
- Location: `/reports/cucumber-report.html`, `/reports/cucumber-report.json`
- Basic test execution summary

### 2. Allure Report (Primary)
- Location: `/allure-report/index.html`
- Interactive dashboard with test statistics, trends, categorization
- Open with: `npm run allure:open`

### 3. TEST_SUMMARY.md
Comprehensive markdown summary with:
- Test Results (Total, Passed, Failed, Success Rate)
- Test Coverage by Endpoint (✅/❌/⚠️ status)
- **Failed Test Cases**:
  - **Positive Scenarios**: Swagger-defined success responses that failed
  - **Negative Scenarios**: Tests with wrong error codes
  - **Schema Validation Failures**: Response structure mismatches
- **Not Applicable Test Cases**: Tests failing due to missing API validation
- **API Issues Requiring Attention**: Critical vs Behavior Issues
- Execution Details, Steps, Duration
- Next Steps (prioritized action items)

---

## Failure Categorization

Document all failures in TEST_SUMMARY.md under these categories:

### Category 1: Positive Scenario Failures (CRITICAL)
- **Definition**: Swagger-defined success responses (200/201/204) that failed
- **Example**: POST expects 200 per Swagger but returns 500
- **Action**: Indicates API bugs - do NOT modify assertions

### Category 2: Negative Scenario Failures - Validation Gaps
- **Definition**: API returns 200 instead of 400 (missing input validation)
- **Documentation**: List in "Not Applicable Test Cases" section
- **Example**: Missing required parameter returns 200 instead of 400

### Category 3: Negative Scenario Failures - Wrong Error Code
- **Definition**: API returns wrong error code (500 instead of 400/404)
- **Documentation**: List in "Failed Test Cases → Negative Scenarios"
- **Example**: Invalid payload returns 500 instead of 400

### Category 4: Schema Validation Failures (CRITICAL)
- **Definition**: Response structure doesn't match API specification
- **Documentation**: List in "Failed Test Cases → Schema Validation Failures"
- **Examples**: Missing required fields, wrong data types, unexpected fields

---

## Critical Rules

### ❌ NEVER Do:
- Modify assertions to match actual API behavior
- Add graceful handling that skips failed assertions
- Change expected status codes based on API responses
- Add "# Note:" comments in feature files
- Mark tests as passing when they should fail
- Skip schema validation when it fails

### ✅ ALWAYS Do:
- Let tests fail when API behavior is wrong
- Stick to Swagger definitions for positive scenarios
- Document failures comprehensively in TEST_SUMMARY.md
- Categorize failures correctly (Critical vs Validation Gaps vs Schema Violations)
- Perform schema validation on GET responses (200)
- Perform schema validation on POST/PUT responses IF they return an object

---

## Execution Workflow

When agent is invoked:

1. **Read Configuration**:
   - Read `.env` for `INPUT_TYPE`, `INPUT_PATH`, `BASE_URL`, `AUTH_TYPE`, credentials

2. **Parse API Specification**:
   - Fetch/read specification from configured location
   - Validate Swagger 2.0 or OpenAPI 3.0 format
   - Extract endpoints, operations, request/response schemas, authentication

3. **Generate Test Suite**:
   - Data models (JavaScript classes) for each endpoint
   - Gherkin feature files with positive/negative scenarios
   - Step definitions using Playwright APIRequestContext
   - API helpers with methods per operation
   - Schema validator using Ajv
   - Hooks and world.js for Playwright context
   - Allure converter script (generate-allure.js)
   - All required configuration files

4. **Execute Tests**:
   - Run all tests using `npm test`
   - Apply retry logic (3 attempts per scenario)
   - Allow tests to fail naturally when API behavior differs from specification - Do NOT modify assertions

5. **Generate Reports**:
   - Cucumber HTML/JSON reports (auto-generated during test run)
   - Convert Cucumber JSON to Allure format using `npm run generate:allure`
   - Generate Allure dashboard using `npm run allure:report`
   - Create TEST_SUMMARY.md with comprehensive failure categorization

6. **Document Results**:
   - Categorize failures: Critical, Validation Gaps, Wrong Error Codes, Schema Violations
   - Provide clear next steps and prioritized action items

---

## Success Criteria

Generated test suite must:
- Execute using `npm test` (tests may fail - this is expected)
- Validate response codes against Swagger definitions strictly
- Validate response schemas (required fields + data types)
- Log meaningful console output with clear failure reasons
- Produce multiple report formats showing actual pass/fail status
- Generate comprehensive TEST_SUMMARY.md documenting all failures
- **NEVER modify assertions to make tests pass artificially**
- Clearly distinguish between:
  - Critical failures (positive scenarios + schema violations)
  - Validation gap failures (negative tests returning 200)
  - Error handling failures (negative tests returning wrong codes)

---

## Agent Invocation

**Method 1 - Reference this file directly**:
```
@workspace #file:copilot-instructions.md Generate API tests
```

**Method 2 - Simple prompt (automatic - recommended)**:
```
Generate Playwright + Cucumber API tests for all endpoints in the API specification configured in the .env file
```

The agent will:
✅ Read `.env` configuration  
✅ Parse API specification from configured location  
✅ Generate complete test suite with schema validation  
✅ Execute tests with automatic retry (3 attempts)  
✅ Generate Cucumber, Allure, and markdown reports  
✅ Document all failures with proper categorization  

**No additional input required** - everything is configured in `.env` file.

---

**Agent Version**: 1.0  
**Last Updated**: November 2025  
**Maintained By**: API Automation Team
